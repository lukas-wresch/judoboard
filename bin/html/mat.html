<div style="margin-left: 0.5cm; font-size: 20pt;">
  <label id="mat"></label> - <label id="time"></label>: <span id="hajimetime"></span><br/>
  <label class="matchtable_label"></label>: <label id="matchtable"></label><br/>
  <label id="total_time_label"></label>: <label id="total_time"></label>
</div>

<table border="1" rules="all" style="margin-top: 3mm; margin-bottom: 0mm; width: 21.0cm;">
  <tr id="next_matches_row" style="display:none;">
    <td style="text-align: center; font-size: 16pt; width: 100%;">
      <div id="next_matches_div" style="display:none; height: 0px;">
      <table width="100%" id="next_matches_table" border="0" rules="all">
        <tr>
          <td></td>
          <td id="next_matches" style="width: 14.15cm; text-align: center; font-size: 16pt;" colspan="2"></td>
          <td></td>
        </tr>
      </table>
      </div>
    </td>
  </tr>
</table>

<table border="1" rules="all" style="margin-top: 0mm; margin-bottom: 3mm; width: 100%;">
  <tr id="current_match_row">
    <td style="text-align: center; font-size: 18pt;" colspan="2">
      <div id="current_match_div" style="height: 35px;">
        <table width="100%" id="current_match_table" style="height: 36px;" border="0" rules="all">
          <tr><td width="50%" id="white_name">- - -</td><td id="blue_name" style="background-color: rgba(30, 30, 255, 1.0); color: white;">- - -</td></tr>
        </table>
      </div>
    </td>

    <td style="width: 5.0cm; border-right-style: hidden; border-bottom-style: hidden; border-top-style: hidden;"></td>
  </tr>

  <tr>
    <td style="width: 65mm; text-align: center; background-color: rgba(255, 255, 255, 0.9)">
      <span class="score" id="white_ippon">0</span> <span class="score" id="white_wazaari">0</span> <span class="score" style="display: none;" id="white_yuko"></span> <span class="score" style="display: none;" id="white_koka"></span>
    </td>

    <td style="width: 65mm; text-align: center; background-color: rgba(30, 30, 255, 1.0); color: white;">
      <span class="score" id="blue_ippon">0</span> <span class="score" id="blue_wazaari">0</span> <span class="score" style="display: none;" id="blue_yuko"></span> <span class="score" style="display: none;" id="blue_koka"></span>
    </td>

    <td style="text-align: center; font-size: 18pt; width: 6.9cm; border-right-style: hidden; border-bottom-style: hidden;">
      <button disabled class="neutral" style="height: 7vh; width: 45mm; margin-top: 3mm; margin-right: 20mm; display: none;" id="end_match" onclick="EndMatch(event)" ontouchstart="EndMatch(event)">End match</button>
    </td>
  </tr>

  <tr>
    <td style="text-align: center;">
      <button class="add" id="add_ippon_white"   style="height: 7vh;" onclick="SetScore('white', '+ippon', event);" ontouchstart="SetScore('white', '+ippon', event);">+Ippon</button>
      <button class="add" id="add_wazaari_white" style="height: 7vh; margin-left: 5mm;" onclick="SetScore('white', '+wazaari', event);" ontouchstart="SetScore('white', '+wazaari', event);">+Waza-Ari</button>
      <br/>
      <button class="remove" id="rem_ippon_white"   style="height: 7vh;" onclick="SetScore('white', '-ippon', event);" ontouchstart="SetScore('white', '-ippon', event);">-Ippon</button>
      <button class="remove" id="rem_wazaari_white" style="height: 7vh; margin-left: 5mm;" onclick="SetScore('white', '-wazaari', event);" ontouchstart="SetScore('white', '-wazaari', event);">-Waza-Ari</button>
      <br/>
      <button disabled class="neutral" id="white_osaekomi" style="height: 7vh;" onclick="Osaekomi('white', event);" ontouchstart="Osaekomi('white', event);">Osaekomi</button>
      <button disabled class="neutral" style="height: 7vh; margin-left: 5mm;" id="tokeda1" onclick="Tokeda(event);" ontouchstart="Tokeda(event);">Tokeda</button>
    </td>

    <td style="text-align: center;">
      <button class="add" id="add_ippon_blue"   style="height: 7vh;" onclick="SetScore('blue', '+ippon', event);" ontouchstart="SetScore('blue', '+ippon', event);">+Ippon</button>
      <button class="add" id="add_wazaari_blue" style="height: 7vh; margin-left: 5mm;" onclick="SetScore('blue', '+wazaari', event);" ontouchstart="SetScore('blue', '+wazaari', event);">+Waza-Ari</button>
      <br/>
      <button class="remove" id="rem_ippon_blue"   style="height: 7vh;" onclick="SetScore('blue', '-ippon', event);" ontouchstart="SetScore('blue', '-ippon', event);">-Ippon</button>
      <button class="remove" id="rem_wazaari_blue" style="height: 7vh; margin-left: 5mm;" onclick="SetScore('blue', '-wazaari', event);" ontouchstart="SetScore('blue', '-wazaari', event);">-Waza-Ari</button>
      <br/>
      <button disabled class="neutral" id="blue_osaekomi" style="height: 7vh;" onclick="Osaekomi('blue', event);" ontouchstart="Osaekomi('blue', event);">Osaekomi</button>
      <button disabled class="neutral" style="height: 7vh; margin-left: 5mm;" id="tokeda2" onclick="Tokeda(event);" ontouchstart="Tokeda(event);">Tokeda</button>
    </td>

    <td style="text-align: center; font-size: 18pt; vertical-align: top; border-right-style: hidden; border-bottom-style: hidden;" rowspan="8">
      <div id="osaekomi_list_div" style="width: 6.4cm; margin-left: 4mm; display: none;">
        <div style="margin-bottom: 3mm;">
          <label style="text-decoration: underline;">Osaekomis:</label>
        </div>
        <table id="osaekomi_list" border="1" rules="all" width="100%">
          <tr><th style="width: 50%;" id="osaekomi_for"></th><th style="width: 50%;" id="osaekomi_time"></th></tr>
        </table>
      </div>
    </td>
  </tr>

  <tr id="yuko_koka_row" style="text-align: center; display: none;">
    <td>
      <button class="add" id="add_yuko_white" onclick="SetScore('white', '+yuko', event);">+Yuko</button>
      <button class="add" id="add_koka_white" style="margin-left: 5mm;" onclick="SetScore('white', '+koka', event);">+Koka</button>
      <br/>
      <button class="remove" id="rem_yuko_white" onclick="SetScore('white', '-yuko', event);">-Yuko</button>
      <button class="remove" id="rem_koka_white" style="margin-left: 5mm;" onclick="SetScore('white', '-koka', event);">-Koka</button>
    </td>

    <td style="text-align:">
      <button class="add" id="add_yuko_blue" onclick="SetScore('blue', '+yuko', event);">+Yuko</button>
      <button class="add" id="add_koka_blue" style="margin-left: 5mm;" onclick="SetScore('blue', '+koka', event);">+Koka</button>
      <br/>
      <button class="remove" id="rem_yuko_blue" onclick="SetScore('blue', '-yuko', event);">-Yuko</button>
      <button class="remove" id="rem_koka_blue" style="margin-left: 5mm;" onclick="SetScore('blue', '-koka', event);">-Koka</button>
    </td>
  </tr>

  <tr>
    <td style="text-align: center;">
      <h2>Osaekomi: <span id="white_osaekomitime">0.0</span></h2>
    </td>
    <td style="text-align: center;">
      <h2>Osaekomi: <span id="blue_osaekomitime">0.0</span></h2>
    </td>
  </tr>

  <tr>
    <td style="text-align: center;" colspan="2">
      <button class="neutral" id="hajime" style="height: 7vh;" onclick="Hajime(event)" ontouchstart="Hajime(event)">Hajime</button>
      <button disabled class="neutral" id="mate" style="height: 7vh; margin-left: 5mm;" onclick="Mate(event)" ontouchstart="Mate(event)">Mate</button>
      <button class="additional" id="more" style="height: 7vh; margin-left: 44mm" onclick="ToggleMore();">More</button>
    </td>
  </tr>

  <tr id="row_hansokumake_decision_white" style="display: none;">
    <td colspan="2">
      <div id="div_hansokumake_decision_white" style="display: none; height: 0px; text-align: center;">
        <h2>Hansokumake: <label id="label_hansokumake_desc_white">White</label></h2>
        <button class="remove" style="width: 4.5cm;"                   onclick="SetScore('white', '+disqualification', event); ShowHansokumakeDecision(false, 'white');">Disqualification</button>
        <button class="add"    style="margin-left: 2cm; width: 4.5cm;" onclick="SetScore('white', '-disqualification', event); ShowHansokumakeDecision(false, 'white');">No Disqualification</button>
      </div>
    </td>
  </tr>

  <tr id="row_hansokumake_decision_blue" style="display: none;">
    <td colspan="2">
      <div id="div_hansokumake_decision_blue" style="display: none; height: 0px; text-align: center;">
        <h2>Hansokumake: <label id="label_hansokumake_desc_blue">Blue</label></h2>
        <button class="remove" style="width: 4.5cm;"                   onclick="SetScore('blue', '+disqualification', event); ShowHansokumakeDecision(false, 'blue');">Disqualification</button>
        <button class="add"    style="margin-left: 2cm; width: 4.5cm;" onclick="SetScore('blue', '-disqualification', event); ShowHansokumakeDecision(false, 'blue');">No Disqualification</button>
      </div>
    </td>
  </tr>

  <tr id="row_additional1" style="display: none;">

    <td style="text-align: center;">
      <div id="additional2" style="display: none; height: 0px;">
        <div style="font-size: 18pt;">
          <label>Shidos:</label> <span id="white_shidos">0</span>
        </div>
        <button class="add" onclick="SetScore('white', '+shido', event);">+Shido</button>
        <button class="add" onclick="SetScore('white', '+hansokumake', event);">+Hansoku-Make</button>
        <br/>
        <button class="remove" onclick="SetScore('white', '-shido', event);">-Shido</button>
        <button class="remove" onclick="SetScore('white', '-hansokumake', event);">-Hansoku-Make</button>
      </div>
    </td>

    <td style="text-align: center;">
      <div id="additional1" style="display: none; height: 0px;">
        <div style="font-size: 18pt;">
          <label>Shidos:</label> <span id="blue_shidos">0</span>
        </div>
        <button class="add" onclick="SetScore('blue', '+shido', event);">+Shido</button>
        <button class="add" onclick="SetScore('blue', '+hansokumake', event);">+Hansoku-Make</button>
        <br/>
        <button class="remove" onclick="SetScore('blue', '-shido', event);">-Shido</button>
        <button class="remove" onclick="SetScore('blue', '-hansokumake', event);">-Hansoku-Make</button>
      </div>
    </td>

  </tr>

  <tr id="row_additional2" style="display: none;">

    <td style="text-align: center;">
      <div id="additional4" style="display: none; height: 0px;">
        <div style="font-size: 16pt;">
          <label class="medical_examiniations">Medical Examinations</label>: <span id="white_medics">0</span></h2>
        </div>
        <button class="add add_medical_examiniations"       style="width: 5.5cm;" onclick="SetScore('white', '+medic', event);">+Medical Examination</button>
        <br/>
        <button class="remove remove_medical_examiniations" style="width: 5.5cm;" onclick="SetScore('white', '-medic', event);">-Medical Examination</button>
        <br/>
      </div>
    </td>

    <td style="text-align: center;">
      <div id="additional3" style="display: none; height: 0px;">
        <div style="font-size: 16pt;">
          <label class="medical_examiniations">Medical Examinations:</label> <span id="blue_medics">0</span></h2>
        </div>
        <button class="add add_medical_examiniations"    style="width: 5.5cm;" onclick="SetScore('blue', '+medic', event);">+Medical Examination</button>
        <br/>
        <button class="remove remove_medical_examiniations" style="width: 5.5cm;" onclick="SetScore('blue', '-medic', event);">-Medical Examination</button>
        <br/>
      </div>
    </td>

  </tr>

  <tr id="row_decision" style="display: none;">
    <td colspan="2">
      <div id="div_decision" style="display: none; height: 0px; text-align: center; margin-top: 2mm;">
        <button class="white"   style="height: 7vh; width: 3.5cm; margin-right: 3mm;" id="white_wins" onclick="SetScore('white', 'hantei', event); ShowHantei(false);">White wins</button>
        <button class="add"     style="height: 7vh; width: 3.5cm; margin-right: 3mm;" id="draw" onclick="SetScore('', '+draw', event); ShowHantei(false);">Draw</button>
        <button class="additional" style="height: 7vh; width: 3.5cm; margin-right: 3mm;" id="blue_wins" onclick="SetScore('blue', 'hantei', event); ShowHantei(false);">Blue wins</button>
        <button class="neutral" style="height: 7vh; width: 3.5cm;" id="golden_score" onclick="SetScore('', '+golden_score', event); ShowHantei(false); ShowRevokeGoldenScore(true); ">Golden Score</button>
      </div>
    </td>
  </tr>

  <tr id="row_revoke_decision" style="display: none;">
    <td colspan="2">
      <div id="div_revoke_decision" style="display: none; height: 0px; text-align: center;">
        <h2>Hantei: <label id="label_hantei"></label></h2>
        <button class="remove" style="height: 7vh; width: 6.5cm;" id="revoke_hantei" onclick="RevokeHantei();"></button>
      </div>
    </td>
  </tr>

  <tr id="row_revoke_goldenscore" style="display: none;">
    <td colspan="2">
      <div id="div_revoke_goldenscore" style="display: none; height: 0px; text-align: center;">
        <button class="remove" style="width: 7.5cm;" id="revoke_goldenscore" onclick="RevokeGoldenScore();"></button>
      </div>
    </td>
  </tr>
</table>

<script>
var CurrentScore;

var HajimeTimer = 0;
var HajimeTimer_Running = false;

let totalTime = 0;

var OsaekomiWhiteTimer = 0;
var OsaekomiWhiteTimer_Running = false;

var OsaekomiBlueTimer = 0;
var OsaekomiBlueTimer_Running = false;

var ScoreUpdate_Counter = 10;

var show_next_matches = false;

var more = false;
var showHantei = false;
var showRevokeHantei = false;
var showRevokeGoldenScore = false;
var showHansokumakeDecisionWhite = false;
var showHansokumakeDecisionBlue  = false;

let isGoldenscore = false;


function Hajime()
{
  HajimeTimer_Running = true;
  AjaxCallback(host + '/ajax/mat/hajime?id='+id + '&token=' + token, function(response) {
    GetScore();
  });
  ShowRevokeGoldenScore(false);
}


function Mate()
{
  HajimeTimer_Running = false;
  AjaxCallback(host + '/ajax/mat/pause?id='+id + '&token=' + token, function(response) {
    GetScore();
  });

  document.getElementById("blue_osaekomi").disabled  = true;
  document.getElementById("white_osaekomi").disabled = true;
}


function SetScore(who, command, event)
{
  event.preventDefault();

  let url;
  if (who.length >= 1)
    url = host + '/ajax/mat/' + who + '/' + command + '?id='+id + '&token=' + token;
  else
    url = host + '/ajax/mat/' + command + '?id='+id + '&token=' + token;
  AjaxCallback(url, function(response) {
    GetScore();
  });
}


function Osaekomi(who)
{
  AjaxCallback(host + '/ajax/mat/' + who + '/osaekomi?id='+id + '&token=' + token, function(response) {
    GetScore();
  });

  document.getElementById(who+"_osaekomi").disabled = true;
  document.getElementById("tokeda1").disabled = false;
}


function Tokeda()
{
  AjaxCallback(host + '/ajax/mat/tokeda?id='+id + '&token=' + token, function(response) {
    GetOsaekomiList();
    GetScore();
  });
  OsaekomiWhiteTimer = false;
  OsaekomiBlueTimer  = false;
  document.getElementById("white_osaekomi").disabled = false;
  document.getElementById("blue_osaekomi").disabled  = false;
  document.getElementById("tokeda1").disabled = true;
  document.getElementById("tokeda2").disabled = true;
}


function StartNextMatch(event)
{
  event.preventDefault();

  AjaxCallback(host + '/ajax/mat/start_match?id='+id + '&token=' + token, function(response) {
    if (response != "ok")
        alert("Error: " + response);
    GetScore();
    GetJudokaName();
  });
}


function EndMatch(event)
{
  event.preventDefault();

  AjaxCallback(host + '/ajax/mat/end_match?id='+id + '&token=' + token, function(respone) {
    GetJudokaName();
    GetScore();
  });
}


function RevokeHantei()
{
  if (!CurrentScore.has_concluded)
    return;

  if (CurrentScore.has_concluded && CurrentScore.winner == 2)
    Ajax(host + '/ajax/mat/-draw?id=' + id + '&token=' + token);
  else
    Ajax(host + '/ajax/mat/-hantei?id=' + id + '&token=' + token);
}


function RevokeGoldenScore()
{
  if (!CurrentScore.is_goldenscore)
    return;

  Ajax(host + '/ajax/mat/-golden_score?id=' + id + '&token=' + token);

  ShowRevokeGoldenScore(false);
  ShowHantei(true);
}


function MoveUp(index, match_id, event)
{
  event.preventDefault();

  let table = document.getElementById("next_matches_table");

  table.rows[  index*2-1].cells[1].innerHTML = "- - -";
  table.rows[  index*2-1].cells[2].innerHTML = "- - -";
  table.rows[  index*2  ].cells[0].innerHTML = "- - -";
  table.rows[  index*2  ].cells[1].innerHTML = "- - -";

  table.rows[2+index*2-1].cells[1].innerHTML = "- - -";
  table.rows[2+index*2-1].cells[2].innerHTML = "- - -";
  table.rows[2+index*2  ].cells[0].innerHTML = "- - -";
  table.rows[2+index*2  ].cells[1].innerHTML = "- - -";

  AjaxCallback('/ajax/match/move_up?id=' + match_id + '&mat=' + id, function(resp) {
      GetJudokaName();
  });
  return false;
}


function ToggleMore()
{
  if (more)
  {
    $("#additional1").animate({height: '0px', opacity: 0}, 1000);
    $("#additional2").animate({height: '0px', opacity: 0}, 1000);
    $("#additional3").animate({height: '0px', opacity: 0}, 1000);
    $("#additional4").animate({height: '0px', opacity: 0}, 1000);

    $("#row_additional1").hide(1000);
    $("#row_additional2").hide(1000);

    $("#more").text(translate('more'));
  }
  else
  {
    $("#row_additional1").show();
    $("#row_additional2").show();

    $("#additional1").show().animate({height: '180px', opacity: 100}, 1000);
    $("#additional2").show().animate({height: '180px', opacity: 100}, 1000);
    $("#additional3").show().animate({height: '120px', opacity: 100}, 1000);
    $("#additional4").show().animate({height: '120px', opacity: 100}, 1000);

    $("#more").text(translate('less'));
  }

  more = !more;
}



function ShowNextMatches(show)
{
  if (show_next_matches == show)
    return;

  if (!show)
  {
    $("#next_matches_div").animate({height: '0px', opacity: 0}, 1000);
    $("#next_matches_row").hide(1000);

    $("#current_match_row").show();
    $("#current_match_div").show().animate({height: '35px', opacity: 100}, 1000);
  }
  else
  {
    $("#next_matches_row").show();
    $("#next_matches_div").show().animate({height: '190px', opacity: 100}, 1000);

    $("#current_match_div").animate({height: '0px', opacity: 0}, 1000);
    $("#current_match_row").hide(1000);
  }

  show_next_matches = show;
}



function ShowHantei(show)
{
  if (show == showHantei)
    return;

  if (show)
  {
    $("#row_decision").show();
    $("#div_decision").show().animate({height: '9vh', opacity: 100}, 1000);
  }
  else
  {
    $("#div_decision").animate({height: '0px', opacity: 0}, 1000);
    $("#row_decision").hide(1000);
  }

  showHantei = show;
}


function ShowRevokeHantei(show)
{
  if (show == showRevokeHantei)
    return;

  if (show)
  {
    $("#row_revoke_decision").show();
    $("#div_revoke_decision").show().animate({height: '14vh', opacity: 100}, 1000);
  }
  else
  {
    $("#div_revoke_decision").animate({height: '0px', opacity: 0}, 1000);
    $("#row_revoke_decision").hide(1000);
  }

  showRevokeHantei = show;
}


function ShowRevokeGoldenScore(show)
{
  if (show == showRevokeGoldenScore)
    return;

  if (show)
  {
    $("#row_revoke_goldenscore").show();
    $("#div_revoke_goldenscore").show().animate({height: '50px', opacity: 100}, 1000);
  }
  else
  {
    $("#div_revoke_goldenscore").animate({height: '0px', opacity: 0}, 1000);
    $("#row_revoke_goldenscore").hide(1000);
  }

  showRevokeGoldenScore = show;
}


function ShowHansokumakeDecision(show, whom)
{
    if (whom == 'white')
    {
        if (show == showHansokumakeDecisionWhite)
            return;
        showHansokumakeDecisionWhite = show;
    }
    else
    {
        if (show == showHansokumakeDecisionBlue)
            return;
        showHansokumakeDecisionBlue = show;
    }

  if (show)
  {
    $("#row_hansokumake_decision_" + whom).show();
    $("#div_hansokumake_decision_" + whom).show().animate({height: '100px', opacity: 100}, 1000);
  }
  else
  {
    $("#div_hansokumake_decision" + whom).animate({height: '0px', opacity: 0}, 1000);
    $("#row_hansokumake_decision" + whom).hide(1000);
  }
}



let updateScore = false;

function GetScore()
{
  if (updateScore)
    return;

  updateScore = true;

  AjaxCallback(host + "/ajax/mat/get_score?id="+id, function(response) {
    console.log(response);
    const res = YAML.parse(response);

    if (res.white.ippon == 1)
      res.white.wazaari = 0;
    if (res.blue.ippon == 1)
      res.blue.wazaari = 0;

    CurrentScore = res;

    updateScore = false;

    document.getElementById("white_ippon").innerHTML   = res.white.ippon;
    document.getElementById("white_wazaari").innerHTML = res.white.wazaari;
    document.getElementById("blue_ippon").innerHTML    = res.blue.ippon;
    document.getElementById("blue_wazaari").innerHTML  = res.blue.wazaari;

    if (res.yuko_enabled)
    {
      document.getElementById("white_yuko").style.display = '';
      document.getElementById("blue_yuko").style.display  = '';
      document.getElementById("white_yuko").innerHTML = res.white.yuko;
      document.getElementById("blue_yuko").innerHTML  = res.blue.yuko;

      document.getElementById("white_ippon").style.fontSize = "45pt";
      document.getElementById("white_ippon").style.marginRight= '0mm';
      document.getElementById("white_wazaari").style.fontSize = "45pt";
      document.getElementById("white_wazaari").style.marginRight= '0mm';
      document.getElementById("white_yuko").style.fontSize = "45pt";

      document.getElementById("blue_ippon").style.fontSize = "45pt";
      document.getElementById("blue_ippon").style.marginRight= '0mm';
      document.getElementById("blue_wazaari").style.fontSize = "45pt";
      document.getElementById("blue_wazaari").style.marginRight= '0mm';
      document.getElementById("blue_yuko").style.fontSize = "45pt";
    }
    else
    {
      document.getElementById("white_yuko").style.display = 'none';
      document.getElementById("blue_yuko").style.display  = 'none';
    }

    if (res.koka_enabled)
    {
      document.getElementById("white_koka").style.display = '';
      document.getElementById("blue_koka").style.display  = '';
      document.getElementById("white_koka").innerHTML = res.white.koka;
      document.getElementById("blue_koka").innerHTML  = res.blue.koka;

      document.getElementById("white_ippon").style.marginLeft= '2mm';
      document.getElementById("white_ippon").style.fontSize = "40pt";
      document.getElementById("white_ippon").style.marginRight= '0mm';
      document.getElementById("white_wazaari").style.fontSize = "40pt";
      document.getElementById("white_wazaari").style.marginRight= '0mm';
      document.getElementById("white_yuko").style.fontSize = "35pt";
      document.getElementById("white_yuko").style.marginRight= '0mm';
      document.getElementById("white_koka").style.fontSize = "35pt";
      document.getElementById("white_koka").style.marginRight= '2mm';

      document.getElementById("blue_ippon").style.marginLeft= '2mm';
      document.getElementById("blue_ippon").style.fontSize = "40pt";
      document.getElementById("blue_ippon").style.marginRight= '0mm';
      document.getElementById("blue_wazaari").style.fontSize = "40pt";
      document.getElementById("blue_wazaari").style.marginRight= '0mm';
      document.getElementById("blue_yuko").style.fontSize = "35pt";
      document.getElementById("blue_yuko").style.marginRight= '0mm';
      document.getElementById("blue_koka").style.fontSize = "35pt";
      document.getElementById("blue_koka").style.marginRight= '2mm';
    }
    else
    {
      document.getElementById("white_koka").style.display = 'none';
      document.getElementById("blue_koka").style.display  = 'none';
    }

    if (res.yuko_enabled || res.koka_enabled)
      document.getElementById("yuko_koka_row").style.display  = '';
    else
      document.getElementById("yuko_koka_row").style.display  = 'none';

    
    document.getElementById("white_shidos").innerHTML = res.white.shido;
    document.getElementById("blue_shidos").innerHTML  = res.blue.shido;

    document.getElementById("white_medics").innerHTML = res.white.medical;
    document.getElementById("blue_medics").innerHTML  = res.blue.medical;


    document.getElementById("add_ippon_white").disabled   = !res.are_fighters_on_mat;
    document.getElementById("add_wazaari_white").disabled = !res.are_fighters_on_mat;
    document.getElementById("add_yuko_white").disabled    = !res.are_fighters_on_mat || !res.yuko_enabled;
    document.getElementById("add_koka_white").disabled    = !res.are_fighters_on_mat || !res.koka_enabled;
    document.getElementById("rem_ippon_white").disabled   = !res.are_fighters_on_mat;
    document.getElementById("rem_wazaari_white").disabled = !res.are_fighters_on_mat;
    document.getElementById("rem_yuko_white").disabled    = !res.are_fighters_on_mat || !res.yuko_enabled;
    document.getElementById("rem_koka_white").disabled    = !res.are_fighters_on_mat || !res.koka_enabled;

    document.getElementById("add_ippon_blue").disabled   = !res.are_fighters_on_mat;
    document.getElementById("add_wazaari_blue").disabled = !res.are_fighters_on_mat;
    document.getElementById("add_yuko_blue").disabled    = !res.are_fighters_on_mat || !res.yuko_enabled;
    document.getElementById("add_koka_blue").disabled    = !res.are_fighters_on_mat || !res.koka_enabled;
    document.getElementById("rem_ippon_blue").disabled   = !res.are_fighters_on_mat;
    document.getElementById("rem_wazaari_blue").disabled = !res.are_fighters_on_mat;
    document.getElementById("rem_yuko_blue").disabled    = !res.are_fighters_on_mat || !res.yuko_enabled;
    document.getElementById("rem_koka_blue").disabled    = !res.are_fighters_on_mat || !res.koka_enabled;

    OsaekomiWhiteTimer = parseInt(res.white.osaekomi_time);
    OsaekomiWhiteTimer_Running = res.white.is_osaekomi_running;
    OsaekomiBlueTimer  = parseInt(res.blue.osaekomi_time);
    OsaekomiBlueTimer_Running = res.blue.is_osaekomi_running;

    OsaekomiBlueTimer_Running = res.blue.is_osaekomi_running;

    if (res.is_osaekomi || (res.was_mate_recent && (OsaekomiWhiteTimer > 0 || OsaekomiBlueTimer > 0 ) ))
    {
      document.getElementById("tokeda1").disabled = false;
      document.getElementById("tokeda2").disabled = false;
    }
    else
    {
      document.getElementById("tokeda1").disabled = true;
      document.getElementById("tokeda2").disabled = true;
    }

    if (res.has_concluded)
    {
      document.getElementById("end_match").disabled = false;
      $('#end_match').show(1000);
    }
    else
    {
      document.getElementById("end_match").disabled = true;
      $("#end_match").hide(1000);
    }


    if (res.is_hajime)
    {
      HajimeTimer_Running = true;
      HajimeTimer = (HajimeTimer + parseInt(res.hajime_time))/2;
      totalTime   = (totalTime   + parseInt(res.total_time) )/2;

      document.getElementById("hajime").innerHTML = "Hajime";
      document.getElementById("hajime").disabled  = true;
      document.getElementById("mate").disabled    = false;

      if (res.white.is_osaekomi_running)
        document.getElementById("white_osaekomi").disabled = true;
      else
        document.getElementById("white_osaekomi").disabled = false;

      if (res.blue.is_osaekomi_running)
        document.getElementById("blue_osaekomi").disabled = true;
      else
        document.getElementById("blue_osaekomi").disabled = false;

      if (res.is_osaekomi)
        document.getElementById("mate").innerHTML = "Sonomama";
      else
        document.getElementById("mate").innerHTML = "Mate";
    }

    else
    {
      HajimeTimer_Running = false;
      HajimeTimer = parseInt(res.hajime_time);
      totalTime   = parseInt(res.total_time);

      if (res.is_osaekomi)
        document.getElementById("hajime").innerHTML = "Yoshi";
      else
        document.getElementById("hajime").innerHTML = "Hajime";

      if (res.white.is_osaekomi_running || res.was_mate_recent)
        document.getElementById("blue_osaekomi").disabled = false;
      else
        document.getElementById("blue_osaekomi").disabled = true;

      if (res.blue.is_osaekomi_running || res.was_mate_recent)
        document.getElementById("white_osaekomi").disabled = false;
      else
        document.getElementById("white_osaekomi").disabled = true;

      if (res.are_fighters_on_mat && !res.has_concluded && !res.is_out_of_time)
        document.getElementById("hajime").disabled = false;
      else
        document.getElementById("hajime").disabled = true;

      document.getElementById("mate").disabled = true;

      document.getElementById("draw").disabled = !res.draw_enabled;
      document.getElementById("golden_score").disabled = !res.golden_score_enabled;
    }


    if (OsaekomiWhiteTimer_Running == 1)
      OsaekomiWhiteTimer_Running = true;
    else
      OsaekomiWhiteTimer_Running = false;

    if (OsaekomiBlueTimer_Running == 1)
      OsaekomiBlueTimer_Running = true;
    else
      OsaekomiBlueTimer_Running = false;


    if (res.are_fighters_on_mat)
      ShowNextMatches(false);
    else
      ShowNextMatches(true);

    if (res.can_next_match_start)
      document.getElementById("hajime").disabled = true;

    if (!res.has_concluded && res.is_out_of_time && res.no_winner_yet)
      ShowHantei(true);
    else
      ShowHantei(false);

    if (res.is_hantei || (res.has_concluded && res.winner == 2))
    {
      if (res.winner == 0)
        document.getElementById('label_hantei').innerHTML = translate('white');
      else if (res.winner == 1)
        document.getElementById('label_hantei').innerHTML = translate('blue');
      else
        document.getElementById('label_hantei').innerHTML = translate('draw');

      ShowRevokeHantei(true);
    }
    else
      ShowRevokeHantei(false);

    isGoldenscore = res.is_goldenscore;
    document.getElementById("golden_score").disabled = isGoldenscore;

    if (typeof res.white.unknown_disqualification !== 'undefined')
        ShowHansokumakeDecision(true, 'white');
    if (typeof res.blue.unknown_disqualification !== 'undefined')
        ShowHansokumakeDecision(true, 'blue');

    DisplayTimer();
  });
}



let updateJudokaName = false;

function GetJudokaName()
{
  if (updateJudokaName)
    return;

  updateJudokaName = true;

  AjaxCallback(host + '/ajax/mat/names_on_mat?id='+id + '&token=' + token, function(response) {
    console.log(response);
    const res = YAML.parse(response);

    updateJudokaName = false;

    document.getElementById("mat").innerHTML = res.mat_name;
    document.getElementById("matchtable").innerHTML = res.match_table_name;

    let name1 = res.white_name;
    if (name1.length > 20)
      name1 = name1.substr(0, 20) + ".";

    let name2 = res.blue_name;
    if (name2.length > 20)
      name2 = name2.substr(0, 20) + ".";

    let white_name;
    let blue_name;

    let hidden = 'hidden="" ';
    if (CurrentScore.has_concluded && CurrentScore.winner == 0)
      hidden = '';
    white_name = name1 + '<img src="winner.png" id="winner_white" ' + hidden + 'style="width: 5mm; margin-top: 1.5mm; margin-left: 2mm;">';

    hidden = 'hidden="" ';
    if (CurrentScore.has_concluded && CurrentScore.winner == 1)
      hidden = '';
    blue_name = name2 + '<img src="winner.png" id="winner_blue" ' + hidden + 'style="width: 5mm; margin-top: 1.5mm; margin-left: 2mm;">';;

    //Update needed?    
    if (white_name != document.getElementById("white_name").innerHTML || blue_name != document.getElementById("blue_name").innerHTML)
    {
      document.getElementById("white_name").innerHTML = white_name;
      document.getElementById("blue_name").innerHTML  = blue_name;
    }

    let table = document.getElementById("next_matches_table");

    while (table.rows.length > 1)
      table.deleteRow(table.rows.length-1);

    let i = 0;
    for (const match of res.next_matches)
    {
      let row1  = table.insertRow(-1);
      let cell0 = row1.insertCell(-1);
      let cell1 = row1.insertCell(-1);
      let cell2 = row1.insertCell(-1);

      if (typeof match.match_table_desc !== 'undefined')
        cell1.innerHTML = match.match_table_desc;

      let row2  = table.insertRow(-1);
      let cell3 = row2.insertCell(-1);
      let cell4 = row2.insertCell(-1);

      let cell5 = row1.insertCell(-1);

      cell0.rowSpan  = '2';
      cell5.rowSpan  = '2';

      cell0.innerHTML = (i+1) + '.';

      cell3.innerHTML = match.white_name;
      cell4.innerHTML = match.blue_name;
      cell0.style = "width: 0.75cm; font-size: 24pt;";
      cell3.style = "width: 6.10cm;";
      cell4.style = "width: 6.95cm; background-color: rgba(30, 30, 255, 1.0); color: white;";

      let current_breaktime = Math.floor(match.current_breaktime/60) + ':' + zeroPad(Math.floor(match.current_breaktime)%60, 2);
      let breaktime         = Math.floor(match.breaktime/60) + ':' + zeroPad(Math.floor(match.breaktime)%60, 2);

      cell2.innerHTML = translate('break_time') + ': &nbsp;&nbsp;&nbsp;';

      if (match.current_breaktime >= 60*60)
        cell2.innerHTML += '- - -';
      else if (match.breaktime > 0)
        cell2.innerHTML += current_breaktime + ' / ' + breaktime;
      else
        cell2.innerHTML += current_breaktime;

      if (match.current_breaktime < match.breaktime)
      {
        if (match.current_breaktime + 30 > match.breaktime)
          cell2.style.backgroundColor = "#ff6d";
        else
          cell2.style.backgroundColor = "#e33d";
      }


      if (i == 0)
      {
        let dis = 'disabled';
        if (CurrentScore.can_next_match_start && match.current_breaktime >= match.breaktime)
          dis = '';

        cell5.innerHTML = '<button ' + dis + ' class="neutral" style="width: 50mm; margin-top: 1mm;" onclick="StartNextMatch(event)" ontouchstart="StartNextMatch(event)">' + translate('start_next_match') + '</button>';
      }
      else
        cell5.innerHTML = '<button class="neutral" style="width: 50mm; margin-top: 1mm;" onclick="MoveUp(' + i + ', \'' + match.uuid + '\', event)" ontouchstart="MoveUp(' + i + ', \'' + match.uuid + '\', event)">' + translate('push_up') + '</button>';

      i++;
    }


    for (; i < 3; i++)
    {
      let row = table.insertRow(-1);

      let cell1 = row.insertCell(-1);
      let cell2 = row.insertCell(-1);
      let cell3 = row.insertCell(-1);

      cell1.style = "width: 7.4cm;";
      cell2.style = "width: 7.4cm; background-color: rgba(30, 30, 255, 1.0); color: white;";

      cell1.innerHTML = '- - -';
      cell2.innerHTML = '- - -';
      cell3.innerHTML = ' ';
    }

  });
}



let updateOsaekomiList = false;

function GetOsaekomiList()
{
  if (updateOsaekomiList)
    return;

  updateOsaekomiList = true;

  AjaxCallback("ajax/mat/get_osaekomilist?id="+id, function(response) {
    console.log(response);
    const res = response.split(",");

    updateOsaekomiList = false;

    let table = document.getElementById("osaekomi_list");

    while (table.rows.length > 1)
      table.deleteRow(table.rows.length-1);

    if (res.length <= 1)
    {
      $("#osaekomi_list_div").hide(1000);
      return;
    }
    else
      $("#osaekomi_list_div").show(1000);

    for (let i=0; i < res.length; i+=2)
    {
      let row = table.insertRow(-1);

      let cell1 = row.insertCell(0);
      let cell2 = row.insertCell(1);

      if (res[i] == 0)
        cell1.innerHTML = translate('white'); 
      else
        cell1.innerHTML = translate('blue');
      
      cell2.innerHTML = Math.floor((res[i+1]/1000)) + '.' + Math.floor((res[i+1]%1000)/100);
    }
  });
}


function DisplayTimer()
{
  document.getElementById("hajimetime").innerHTML = Math.floor(HajimeTimer/(1000*60)) + ':' + zeroPad(Math.floor((HajimeTimer/1000))%60, 2) + '.' + Math.floor((HajimeTimer%1000)/100);
  document.getElementById("total_time").innerHTML = Math.floor(totalTime  /(1000*60)) + ':' + zeroPad(Math.floor((totalTime  /1000))%60, 2);

  document.getElementById("white_osaekomitime").innerHTML = Math.floor((OsaekomiWhiteTimer/1000)) + '.' + Math.floor((OsaekomiWhiteTimer%1000)/100);
  document.getElementById("blue_osaekomitime").innerHTML  = Math.floor((OsaekomiBlueTimer /1000)) + '.' + Math.floor((OsaekomiBlueTimer %1000)/100);
}


function UpdateTimer()
{
  if (HajimeTimer_Running)
  {
    if (isGoldenscore)
      HajimeTimer += 100;
    else
      HajimeTimer -= 100;

    if (HajimeTimer < 0)
      HajimeTimer = 0;
    totalTime += 100;
    DisplayTimer();
  }

  if (OsaekomiWhiteTimer_Running)
  {
    OsaekomiWhiteTimer += 100;
    DisplayTimer();
  }

  if (OsaekomiBlueTimer_Running)
  {
    OsaekomiBlueTimer += 100;
    DisplayTimer();
  }

  ScoreUpdate_Counter--;
  if (ScoreUpdate_Counter == 0)
  {
    GetScore();
    GetOsaekomiList();
    ScoreUpdate_Counter = 20;
  }
  else if (ScoreUpdate_Counter == 5)
  {
    GetScore();
  }
  else if (ScoreUpdate_Counter == 10)
  {
    GetJudokaName();
    GetScore();
  }
  else if (ScoreUpdate_Counter == 15)
  {
    GetScore();
  }
}


var id = URLDecode(URL, "id");
var host  = '';
var token = '';


function Mat_Init()
{
  if (typeof g_MatList == 'undefined')
  {
    setTimeout(Mat_Init, 100);
    return;
  }

  let index = (id-1) % (g_MatList.highest_mat_id-1);

  if (g_MatList.mats[index].type == 3)
  {
    host  = 'http://' + g_MatList.mats[index].hostname + ':' + g_MatList.mats[index].port;
    token = g_MatList.mats[index].token;
  }

  GetScore();
  GetJudokaName();
  TimerID = window.setInterval(UpdateTimer, 100);


  document.getElementById("time").innerHTML = translate('time');
  document.getElementById("mat").innerHTML  = translate('mat') + ' ' + id;
  document.getElementById("total_time_label").innerHTML = translate('match_time');

  document.getElementById("end_match").innerHTML  = translate('end_match');

  //document.getElementById("label_break").innerHTML = translate('break_time');

  document.getElementById("more").innerHTML = translate('more');

  document.getElementById("next_matches").innerHTML  = translate('next_matches');

  document.getElementById("osaekomi_time").innerHTML = translate('time');
  document.getElementById("osaekomi_for").innerHTML  = translate('for');

  document.getElementById("label_hansokumake_desc_white").innerHTML = translate('white');
  document.getElementById("label_hansokumake_desc_blue" ).innerHTML = translate('blue');

  for (const el of document.getElementsByClassName("matchtable_label"))
    el.innerHTML = translate('match_table');
  for (const el of document.getElementsByClassName("medical_examiniations"))
    el.innerHTML = translate('medical_examiniations');
  for (const el of document.getElementsByClassName("add_medical_examiniations"))
    el.innerHTML = "+" + translate('medical_examiniations');
  for (const el of document.getElementsByClassName("remove_medical_examiniations"))
    el.innerHTML = "-" + translate('medical_examiniations');

  document.getElementById("white_wins").innerHTML = translate('white_wins');
  document.getElementById("blue_wins").innerHTML  = translate('blue_wins');
  document.getElementById("draw").innerHTML  = translate('draw');
  document.getElementById("revoke_hantei").innerHTML  = translate('revoke_hantei');
  document.getElementById("revoke_goldenscore").innerHTML = translate('revoke_goldenscore');
}

Mat_Init();

window.addEventListener("keydown", function(event){
  console.log(event);

  if (event.code == "Numpad0")
    Hajime(event);
  else if (event.code == "NumpadDecimal")
    Mate(event);

  else if (event.code == "Numpad7")
    SetScore('white', '+ippon', event);
  else if (event.code == "Numpad8")
    SetScore('white', '+wazaari', event);
  else if (event.code == "Numpad9")
    SetScore('blue', '+ippon', event);
  else if (event.code == "NumpadSubtract")
    SetScore('blue', '+wazaari', event);

  else if (event.code == "Numpad4")
    SetScore('white', '-ippon', event);
  else if (event.code == "Numpad5")
    SetScore('white', '-wazaari', event);
  else if (event.code == "Numpad6")
    SetScore('blue', '-ippon', event);
  else if (event.code == "NumpadAdd")
    SetScore('blue', '-wazaari', event);

  else if (event.code == "Numpad1")
    Osaekomi('white', event);
  else if (event.code == "Numpad2")
    Tokeda(event);
  else if (event.code == "Numpad3")
    Osaekomi('blue', event);

  else if (event.code == "NumpadEnter")
    EndMatch(event);
  else if (event.code == "Backspace")
    StartNextMatch(event);
});


</script>