<h1 id="headline">New Matchtable</h1>


<div id="div_type">
  <label style="width:100px;float:left;margin-top:4px;" id="label_type">Type</label>
  <select style="margin-bottom:20px; width: 5.5cm;" id="type" onchange="GetForm();">
    <option selected value="1" id="label_weightclass">Weightclass</option>
    <option value="2" id="label_pause">Pause</option>
    <option value="3" id="label_custom">Custom</option>
  </select>
</div>

<div id="div_name">
    <label style="width:100px;float:left;margin-top:4px;" id="label_name">Name</label>
    <input style="margin-bottom:20px;" type="text" id="name" value="" size="40" maxlength="64"/>
</div>

<div id="div_color">
    <label style="width:100px;float:left;margin-top:4px;" id="label_color">Color</label>
    <select style="padding-top:5px;margin-bottom:20px; width: 2.5cm;" id="color">
      <option value="1">Blue</option>
    </select>
</div>


<div>
  <label id="label_mat" style="width:100px;float:left;margin-top:5px;">Mat</label>
  <select style="padding-top:5px;margin-bottom:20px; width: 5.5cm;" id="mat">
  </select>
</div>

<div>
  <label id="label_age_group" style="width:100px;float:left;margin-top:5px;">Age Group</label>
  <select style="padding-top:5px;margin-bottom:20px; width: 5.5cm;" id="age_group">
  </select>
</div>

<div>
  <label id="label_rule_set" style="width:100px;float:left;margin-top:5px;">Rule Set</label>
  <select style="padding-top:5px;margin-bottom:20px; width: 5.5cm;" id="rule">
  </select>
</div>


<div style="border-style: dashed; border-width: 2px; border-color: #ccc; width: 7cm; padding: 0.3cm; margin-bottom: 0.3cm;">
  <form id="form">
  </form>
</div>


<button id="add" class="add" onclick="return AddMatchtable();">Add Match Table</button>
<button id="update" class="neutral" onclick="return UpdateMatchtable();">Update Match Table</button>

<div id="div_delete" style="margin-top: 5mm;">
  <button id="delete" class="remove" onclick="return DeleteMatchtable();">Delete Match Table</button>
</div>

<div id="div_participants" style="margin-top: 1cm;">
  <h2>Participants</h2>
  <table id="participants" border="1" rules="all" style="margin-bottom: 1cm;">
    <tr>
      <th style="width: 0.5cm;" id="no">No.</th>
      <th style="width: 4cm;" id="name">Name</th>
      <th style="width: 2cm; text-align: center;" id="weight">Weight</th>
      <th style="width: 2cm; text-align: center;" id="matches">#Matches</th>
      <th style="width: 3.0cm; text-align: center;">Options</th>
    </tr>
  </table>
</div>


<div id="div_matches">
  <h2>Matches</h2>
  <table id="schedule" border="1" rules="all" style="margin-bottom: 1cm;">
    <tr>
      <th style="width: 0.5cm;" id="no">No.</th>
      <th style="width: 5cm;" id="white">White</th>
      <th style="width: 5cm;" id="blue">Blue</th>
      <th style="width: 1cm;" id="mat">Mat</th>
      <th style="width: 2.5cm; text-align: center;" id="mat">Status</th>
      <th style="width: 2.5cm; text-align: center;">Options</th>
    </tr>
  </table>
</div>

<script>


function GetForm(callback)
{
  AjaxCallback('ajax/matchtable/get_form?type=' + document.getElementById("type").value, function(response) {
    document.getElementById("form").innerHTML = response;

    document.getElementById("label_min_weight").innerHTML = lang.min_weight;
    document.getElementById("label_max_weight").innerHTML = lang.max_weight;
    document.getElementById("label_gender").innerHTML     = lang.gender;
    document.getElementById("all").innerHTML    = lang.all;
    document.getElementById("male").innerHTML   = lang.male;
    document.getElementById("female").innerHTML = lang.female;

    if (typeof callback !== 'undefined')
      callback();
  });

  return false;
}


function AddMatchtable()
{
  var elements = document.getElementById("form").elements;
  var data = [];

  for (var i = 0, element; element = elements[i++];)
  {
      data[element.id] = element.value;
  }

  data["mat"]  = document.getElementById("mat").value;
  data["rule"] = document.getElementById("rule").value;

  console.log(data);

  var params = URLEncode(data);
  console.log(params);

  AjaxPost('ajax/matchtable/add?type=' + document.getElementById("type").value, params, function() {
    navigate("class_list.html");
  });

  return false;
}



function UpdateMatchtable()
{
  var elements = document.getElementById("form").elements;
  var data = [];

  for (var i = 0, element; element = elements[i++];)
      data[element.id] = element.value;

  data["name"]  = document.getElementById("name").value;
  data["color"] = document.getElementById("color").value;
  data["mat"]   = document.getElementById("mat").value;
  data["rule"]  = document.getElementById("rule").value;

  var params = URLEncode(data);

  AjaxPost('ajax/matchtable/update?id=' + id, params, function() {
    navigate("class_list.html");
  });

  return false;
}



function DeleteMatchtable()
{
  if (confirm(lang.delete_matchtable_confirm))
  {
    AjaxCallback('ajax/matchtable/delete?id=' + id, function() {
      navigate("class_list.html");
    });
  }

  return false;
}



function GetMatchTable(id)
{
  AjaxCallback("ajax/matchtable/get?id="+id, function(response) {
    console.log(response);
    var res = response.split(",");

    var elements = document.getElementById("form").elements;

    var i = 0;
    var id   = res[i++];
    var type = res[i++];
    var schedule_index = res[i++];
    var matID  = res[i++];
    var color  = res[i++];
    var ruleID = res[i++];
    var name   = res[i++];

    document.getElementById("name").value = name;
    document.getElementById("type").value = type;
    document.getElementById("type").onchange();

    for (var j=i;j < res.length;j++)
    {
      console.log(elements[j-i]);
      elements[j-i].value = res[j];
    }

    GetMats(function() {
      document.getElementById("mat").value = matID;
    });

    GetRuleSets(function() {
      document.getElementById("rule").value = ruleID;
    });

    GetColors(function() {
      document.getElementById("color").value = color;
      document.getElementById("color").onchange();
    });


    AjaxCallback("ajax/matchtable/get_participants?id="+id, function(response) {
      console.log(response);
      var res = response.split(",");

      if (res.length < 2)
        return;

      var table = document.getElementById("participants");

      while (table.rows.length > 1)
        table.deleteRow(table.rows.length-1);

      var i = 0;
      var no = 0;
      for (var i=0; i < res.length;)
      {
      no++;
      var id   = res[i++];
      var name = res[i++];

      var row = table.insertRow(-1);
      var cell0 = row.insertCell(0);
      var cell1 = row.insertCell(1);
      var cell2 = row.insertCell(2);
      var cell3 = row.insertCell(3);
      var cell4 = row.insertCell(4);

      if (no%2 == 0)
        row.style.backgroundColor = "#eee";

      cell0.innerHTML = no;
      cell0.style.textAlign = "center";
      cell0.style.fontSize  = "14pt";

      cell1.innerHTML = "<a href=\"#judoka_edit.html?id=" + id + "\">" + name + "</a>";
      //cell2.innerHTML = weight + " kg";
      cell2.style.textAlign = "center";
      cell2.style.fontSize  = "16pt";

      //cell3.innerHTML = matches;
      cell3.style.textAlign = "center";
      cell3.style.fontSize  = "16pt";

      cell4.innerHTML = "<button class=\"remove\" style=\"width: 2.5cm; height: 0.9cm;\" onclick=\"return RemoveParticipant("+id+")\">" + lang.remove + "</button>";
      cell4.style.textAlign = "center";
      }
    });
  });


  AjaxCallback("ajax/matchtable/get_matches?id="+id, function(response) {
    var res = response.split(",");

    if (res.length < 4)
      return;

    var table = document.getElementById("schedule");

    while (table.rows.length > 1)
      table.deleteRow(table.rows.length-1);

    console.log(response);

    var no = 0;
    for (var i=0; i < res.length;)
    {
      var row = table.insertRow(-1);
      var cell0 = row.insertCell(0);
      var cell1 = row.insertCell(1);
      var cell2 = row.insertCell(2);
      //var cell3 = row.insertCell(3);
      var cell4 = row.insertCell(3);
      var cell5 = row.insertCell(4);
      var cell6 = row.insertCell(5);

      no++;
      var id    = res[i++];
      var white = res[i++];
      var blue  = res[i++];
      var matID = res[i++];
      var state = res[i++];
      var color = res[i++];
      var matchtableID   = res[i++];
      var matchtableName = res[i++];

      if (no%2 == 0)
        row.style.backgroundColor = "#eee";

      cell0.innerHTML = no;
      cell0.style.textAlign = "center";
      cell0.style.fontSize  = "14pt";
      cell0.style.height    = "1.5cm";

      cell1.innerHTML = white;
      cell2.innerHTML = blue;

      /*if (matchtableID > 0)
        cell3.innerHTML = "<a href=\"#matchtable_add.html?id="+matchtableID+"\">" + matchtableName + "</a>";
      else
        cell3.innerHTML = matchtableName;

      cell3.style.backgroundColor = color;
      cell3.style.textAlign = "center";*/

      if (matID <= 0)
      {
        cell4.style.fontWeight = "bold";
        cell4.innerHTML = "None";
      }
      else
        cell4.innerHTML = matID;

      cell4.style.backgroundColor = Color(matID);
      cell4.style.textAlign = "center";
      cell4.style.fontSize  = "16pt";

      if (state == 0)
        cell5.innerHTML = lang.scheduled;
      else if (state == 1)
      {
        cell5.style.color = "red";
        cell5.innerHTML = lang.running;
      }
      else if (state == 2)
      {
        cell5.style.color = "green";
        cell5.innerHTML = lang.concluded;
      }
      else
        cell5.innerHTML = "Unknown";

      cell5.style.textAlign = "center";

      var style = "border: solid black; border-width: 0 5px 5px 0; display: inline-block; padding: 5px;";


      var options = "<table><tr><td rowspan=\"2\"><button class=\"white\" style=\"width: 2.2cm; margin-right: 0mm;\" onclick=navigate(\"edit_match.html?id="+id+"\");>" + lang.details + "</button></td>";

      options += "<td></td></tr><tr><td></td></tr></table>";

      cell6.innerHTML = options;
    }
  });
}



var id = URLDecode(URL, "id");


if (id)
{
  GetForm(function (){
    GetMatchTable(id);  
  });
 
  document.getElementById("headline").innerHTML = lang.update_matchtable; 
  document.getElementById("add").style.display = "none";
  document.getElementById("div_type").style.display = "none";
}
else
{
  document.getElementById("headline").innerHTML = lang.add_matchtable;
  document.getElementById("update").style.display = "none";
  document.getElementById("delete").style.display = "none";
  document.getElementById("div_name").style.display = "none";
  document.getElementById("div_color").style.display = "none";

  GetForm();
  GetRuleSets();
  GetMats();
}

document.getElementById("add").innerHTML = lang.add_matchtable;
document.getElementById("update").innerHTML = lang.update_matchtable;
document.getElementById("delete").innerHTML = lang.delete_matchtable;
document.getElementById("label_type").innerHTML = lang.type;
document.getElementById("label_mat").innerHTML  = lang.mat;
document.getElementById("label_rule_set").innerHTML = lang.rule_set;
document.getElementById("label_weightclass").innerHTML = lang.weightclass;

</script>