<button class="add" id="new_participant" onclick="navigate('participant_add.html')">New Participant</button>

<button class="add" id="new_match" onclick="navigate('add_match.html')">New Match</button>
<button class="add" id="new_matchtable" onclick="navigate('matchtable_add.html')">New Match table</button>
<button class="add" id="select_age_groups" onclick="navigate('age_groups_select.html')">Select Age Groups</button>

<h2 id="headline-master-schedule">Overview</h2>
<table id="master-schedule" border="1" rules="all" style="margin-bottom: 1cm;">
</table>


<div id="div_hansokumake" style="display: none;">
    <h2 id="hansokumake-headline">Hansokumake</h2>
    <table id="hansokumake" border="1" rules="all" style="margin-bottom: 1cm;">
        <tr>
            <th style="width: 0.5cm;" class="no">No.</th>
            <th style="width: 4cm;" class="white">White</th>
            <th style="width: 4cm;" class="blue">Blue</th>
            <th style="width: 2cm; text-align: center;" class="class">Class</th>
            <th style="width: 1cm;" class="mat">Mat</th>
            <th style="width: 2.5cm; text-align: center;" class="status">Status</th>
            <th style="width: 4.5cm; text-align: center;" class="options">Options</th>
        </tr>
    </table>
</div>

<h2 id="headline">Schedule</h2>
<table id="schedule" border="1" rules="all" style="margin-bottom: 1cm;">
  <tr>
    <th style="width: 0.5cm;" class="no">No.</th>
    <th style="width: 4cm;" class="white">White</th>
    <th style="width: 4cm;" class="blue">Blue</th>
    <th style="width: 2cm; text-align: center;" class="class">Class</th>
    <th style="width: 1cm;" class="mat">Mat</th>
    <th style="width: 2.5cm; text-align: center;" class="status">Status</th>
    <th style="width: 2.5cm; text-align: center;" class="options">Options</th>
  </tr>
</table>
  

<h2 id="headline_age_groups">Age Groups</h2>
<table id="age_groups" border="1" rules="all" style="margin-bottom: 1cm;">
  <tr>
    <th style="width: 0.5cm;" class="no">No.</th>
    <th style="width: 4cm;" id="name">Name</th>
    <th style="width: 2cm; text-align: center;" id="age_groups_participants">#Participants</th>
    <th style="width: 3.0cm; text-align: center;" id="age_groups_match_tables">#Match tables</th>
    <th style="width: 2cm; text-align: center;" id="age_groups_matches" class="num_matches">#Matches</th>
    <th style="width: 3.0cm; text-align: center;" class="options">Options</th>
  </tr>
</table>


<h2 id="headline-participants">Participants</h2>
<table id="participants" border="1" rules="all" style="margin-bottom: 1cm;">
  <tr>
    <th style="width: 0.5cm;" class="no">No.</th>
    <th style="width: 4cm;" id="name">Name</th>
    <th style="width: 2cm; text-align: center;" class="club">Club</th>
    <th style="width: 2cm; text-align: center;" id="weight" class="weight">Weight</th>
    <th style="width: 2cm; text-align: center;" id="matches" class="num_matches">#Matches</th>
    <th style="width: 2.5cm; text-align: center;" id="age_group" class="age_group">Age group</th>
    <th style="width: 3.0cm; text-align: center;" class="options">Options</th>
  </tr>
</table>



<script>


function MoveEntryUp(id)
{
  AjaxCallback('/ajax/masterschedule/move_up?id=' + id, function() {
    Update();
  });
  return false;
}


function MoveEntryDown(id)
{
  AjaxCallback('/ajax/masterschedule/move_down?id=' + id, function() {
    Update();
  });
  return false;
}



function SetEntryMat(id, mat)
{
  AjaxCallback('ajax/masterschedule/set_mat?id='+id+'&mat='+mat, function() {
    Update();
  });

  return false;
}



function MoveUp(id)
{
  AjaxCallback('/ajax/match/move_up?id=' + id, function() {
    Update();
  });
  return false;
}


function MoveDown(id)
{
  AjaxCallback('/ajax/match/move_down?id=' + id, function() {
    Update();
  });
  return false;
}



function RemoveParticipant(id)
{
  AjaxCallback('/ajax/participant/remove?id=' + id, function() {
    Update();
  });
  return false;
}



function Disqualify(fighter, matID)
{
    if (fighter == 0)
        AjaxCallback('/ajax/mat/white/+disqualification?id=' + matID, Update);
    else
        AjaxCallback('/ajax/mat/blue/+disqualification?id='  + matID, Update);
  
  return false;
}



function NoDisqualify(fighter, matID)
{
    if (fighter == 0)
        AjaxCallback('/ajax/mat/white/+nodisqualification?id=' + matID, Update);
    else
        AjaxCallback('/ajax/mat/blue/+nodisqualification?id='  + matID, Update);
  
  return false;
}



function RemoveDisqualify(fighter, matID)
{
    if (fighter == 0)
        AjaxCallback('/ajax/mat/white/-disqualification?id=' + matID, Update);
    else
        AjaxCallback('/ajax/mat/blue/-disqualification?id='  + matID, Update);
  
  return false;
}



function RemoveNoDisqualify(fighter, matID)
{
    if (fighter == 0)
        AjaxCallback('/ajax/mat/white/-nodisqualification?id=' + matID, Update);
    else
        AjaxCallback('/ajax/mat/blue/-nodisqualification?id='  + matID, Update);
  
  return false;
}



function RemoveAgeGroup(id)
{
  AjaxCallback('/ajax/age_groups/remove?id=' + id, function() {
    Update();
  });
  return false;
}



function AssignAgeGroup(judoka_id, age_group_id)
{
  AjaxCallback('/ajax/tournament/assign_age_group?id=' + judoka_id + '&age=' + age_group_id, Update);
  return false;
}



function Update()
{
  AjaxCallback("ajax/get_masterschedule", function(response) {
    console.log(response);

    var res = response.split(",");

    if (res.length < 2)
      return;

    console.log(res);

    var table = document.getElementById("master-schedule");

    while (table.rows.length > 0)
      table.deleteRow(table.rows.length-1);

    var i = 0;
    var mat_count = res[i++];

    var row = table.insertRow(-1);
    for (var j=0; j < mat_count; j++)
    {
      var cell = row.insertCell(j);
      var colspan = res[i++];
      var id = res[i++];

      cell.innerHTML = lang.mat + " " + id;
      cell.style.backgroundColor = Color(id);
      cell.colSpan = colspan;
      cell.style.textAlign = "center";
      cell.style.fontSize  = "16pt";
      cell.style.height = "1.3cm";
    }

    while (i < res.length)
    {
      var row = table.insertRow(-1);

      for (var mat=1; mat <= mat_count;mat++)
      {
        var max         = res[i++];
        var entry_count = res[i++];

        for (var entry=0; entry < entry_count;entry++)
        {
          var editable = res[i++];
          var index    = res[i++];
          var id    = res[i++];
          var color = res[i++];
          var matID = parseInt(res[i++]);
          var name  = res[i++];

          var cell = row.insertCell(-1);

          var style = "border: solid black; border-width: 0 5px 5px 0; display: inline-block; padding: 5px; margin-left: 4mm; margin-right: 3mm;";
          var contents;

          if (editable)
            contents = "<a href=\"#matchtable_add.html?id=" + id + "\">" + name + "</a><br/><br/>";
          else
            contents = name + "<br/>";

          contents += "<table><tr><td rowspan=\"2\"><a style=\"" + style + "transform: rotate(135deg); \" href=\"#\" onclick=\"SetEntryMat('" + id + "'," + (matID-1) + ");\"></a></td>";
          contents += "           <td><a style=\"" + style + "transform: rotate(-135deg); \" href=\"#\" onclick=\"return MoveEntryUp('"   + id + "');\"></a></td>";
          contents += "           <td rowspan=\"2\"><a style=\"" + style + "transform: rotate(-45deg); \" href=\"#\" onclick=\"SetEntryMat('" + id + "'," + (matID+1) + ");\"></a></td></tr>";
          contents += "       <tr><td><a style=\"" + style + "transform: rotate(45deg);\"    href=\"#\" onclick=\"return MoveEntryDown('" + id + "');\"></a></td></tr></table>";


          cell.innerHTML = contents;
          cell.style.backgroundColor = color;
          cell.style.textAlign = "center";
        }

        if (entry_count < max || max == 0)
        {
          var cell = row.insertCell(-1);
          if (entry_count == 0)
            cell.innerHTML = "";
          else
            cell.innerHTML = "";

          cell.style.textAlign = "center";
          cell.colSpan = max - entry_count;
          cell.style.height = "1.3cm";
        }
      }
    }
  });



  AjaxCallback("ajax/get_schedule", function(response) {
    var res = response.split(",");

    if (res.length < 4)
      return;

    var table = document.getElementById("schedule");

    while (table.rows.length > 1)
      table.deleteRow(table.rows.length-1);

    console.log(response);
    var no = 0;
    for (var i=0; i < res.length;)
    {
      no++;
      var row = table.insertRow(-1);
      var cell0 = row.insertCell(0);
      var cell1 = row.insertCell(1);
      var cell2 = row.insertCell(2);
      var cell3 = row.insertCell(3);
      var cell4 = row.insertCell(4);
      var cell5 = row.insertCell(5);
      var cell6 = row.insertCell(6);

      if (no%2 == 0)
        row.style.backgroundColor = "#eee";

      var id    = res[i++];
      var white = res[i++];
      var blue  = res[i++];
      var matID = res[i++];
      var state = res[i++];
      var color = res[i++];
      var matchtableID   = res[i++];
      var matchtableName = res[i++];

      cell0.innerHTML = no;
      cell0.style.textAlign = "center";
      cell0.style.fontSize  = "14pt";
      cell0.style.height    = "1.5cm";

      cell1.innerHTML = white;
      cell2.innerHTML = blue;

      if (matchtableID > 0)
        cell3.innerHTML = "<a href=\"#matchtable_add.html?id="+matchtableID+"\">" + matchtableName + "</a>";
      else
        cell3.innerHTML = matchtableName;

      cell3.style.backgroundColor = color;
      cell3.style.textAlign = "center";

      if (matID <= 0)
      {
        cell4.style.fontWeight = "bold";
        cell4.innerHTML = "None";
      }
      else
        cell4.innerHTML = matID;

      cell4.style.backgroundColor = Color(matID);
      cell4.style.textAlign = "center";
      cell4.style.fontSize  = "16pt";

      if (state == 0)
        cell5.innerHTML = lang.scheduled;
      else if (state == 1)
      {
        cell5.style.color = "red";
        cell5.innerHTML = lang.running;
      }
      else if (state == 2)
      {
        cell5.style.color = "green";
        cell5.innerHTML = lang.concluded;
      }
      else
        cell5.innerHTML = "Unknown";

      cell5.style.textAlign = "center";

      var style = "border: solid black; border-width: 0 5px 5px 0; display: inline-block; padding: 5px;";


      var options = "<table><tr><td rowspan=\"2\"><button class=\"white\" style=\"width: 1.8cm; margin-right: 2mm;\" onclick=navigate(\"edit_match.html?id="+id+"\");>" + lang.details + "</button></td>";

      if (state == 0)
        options += "<td><a style=\"" + style + "transform: rotate(-135deg); \" href=\"#\" onclick=\"return MoveUp('"+id+"')\"></a></td></tr><tr><td><a style=\"" + style + "transform: rotate(45deg);\"   href=\"#\" onclick=\"return MoveDown('"+id+"');\"></a></td></tr></table>";
      else
        options += "<td></td></tr><tr><td></td></tr></table>";

      cell6.innerHTML = options;
    }
  });



  AjaxCallback("ajax/age_groups/get", function(response) {
    console.log(response);
    var res = YAML.parse(response);

    var table = document.getElementById("age_groups");

    while (table.rows.length > 1)
      table.deleteRow(table.rows.length-1);

    var no = 0;
    for (const age of res)
    {
      var row = table.insertRow(-1);
      var cell0 = row.insertCell(0);
      var cell1 = row.insertCell(1);
      var cell2 = row.insertCell(2);
      var cell3 = row.insertCell(3);
      var cell4 = row.insertCell(4);
      var cell5 = row.insertCell(4);

      if (no%2 == 0)
        row.style.backgroundColor = "#eee";
      no++;

      cell0.innerHTML = no;
      cell0.style.textAlign = "center";
      cell0.style.fontSize  = "14pt";

      cell1.innerHTML = "<a href=\"#age_groups_add.html?id=" + age.uuid + "\">" + age.name + "</a>";

      cell2.innerHTML = age.num_participants;
      cell2.style.textAlign = "center";
      cell2.style.fontSize  = "16pt";

      cell3.innerHTML = age.num_match_tables;
      cell3.style.textAlign = "center";
      cell3.style.fontSize  = "16pt";

      cell4.innerHTML = age.num_matches;
      cell4.style.textAlign = "center";
      cell4.style.fontSize  = "16pt";

      cell5.innerHTML = "<button class=\"remove\" style=\"width: 2.5cm; height: 0.9cm;\" onclick=\"return RemoveAgeGroup('"+age.uuid+"')\">" + lang.remove + "</button>";
      cell5.style.textAlign = "center";
    }
  });



  AjaxCallback("ajax/participants/get", function(response) {
    console.log(response);
    var res = YAML.parse(response);

    var table = document.getElementById("participants");

    while (table.rows.length > 1)
      table.deleteRow(table.rows.length-1);

    var no = 0;
    for (const judoka of res)
    {
      var row = table.insertRow(-1);
      var cell0 = row.insertCell(0);
      var cell1 = row.insertCell(1);
      var cell6 = row.insertCell(2);
      var cell2 = row.insertCell(3);
      var cell3 = row.insertCell(4);
      var cell4 = row.insertCell(5);
      var cell5 = row.insertCell(6);

      if (no%2 == 0)
        row.style.backgroundColor = "#eee";
      no++;

      cell0.innerHTML = no;
      cell0.style.textAlign = "center";
      cell0.style.fontSize  = "14pt";

      cell1.innerHTML = "<a href=\"#judoka_add.html?id=" + judoka.uuid + "\">" + judoka.name + "</a>";
      cell2.innerHTML = judoka.weight + " kg";
      cell2.style.textAlign = "center";
      cell2.style.fontSize  = "16pt";

      if (typeof judoka.club_name !== 'undefined')
        cell6.innerHTML = judoka.club_name;
      else
        cell6.innerHTML = "- - -";
      cell6.style.textAlign = "center";
      cell6.style.fontSize  = "16pt";

      cell3.innerHTML = judoka.num_matches;
      cell3.style.textAlign = "center";
      cell3.style.fontSize  = "16pt";

      cell4.style.textAlign = "center";
      
      if (judoka.age_groups.length == 0)
        cell4.innerHTML = "- - -";
      else if (judoka.age_groups.length == 1)
      {
        cell4.innerHTML = judoka.age_groups[0].name;
        cell4.style.fontSize = "14pt";
      }
      else
      {
        var select = document.createElement("select");
        select.style.width = "1.7cm";
        select.style.fontSize  = "14pt";

        for (const age_group of judoka.age_groups)
        {
          var option = document.createElement("option");
          option.value = age_group.uuid;
          option.text  = age_group.name;

          select.appendChild(option);
        }

        if (typeof judoka.age_group_uuid !== 'undefined')
          select.value = judoka.age_group_uuid;

        select.onchange = function(e)
        {
          AssignAgeGroup(judoka.uuid, select.value);
        }

        cell4.appendChild(select);
      }

      cell5.innerHTML = "<button class=\"remove\" style=\"width: 2.5cm; height: 0.9cm;\" onclick=\"return RemoveParticipant('"+judoka.uuid+"')\">" + lang.remove + "</button>";
      cell5.style.textAlign = "center";
    }
  });



  AjaxCallback("ajax/hansokumake/get", function(response) {
    console.log(response);
    var res = response.split(",");

    if (res.length < 4)
    {
       $("#div_hansokumake").animate({height: '0px', opacity: 0}, 1000);
       showHansokumake = false;
       return;
    }

    var table = document.getElementById("hansokumake");

    while (table.rows.length > 1)
      table.deleteRow(table.rows.length-1);

    var no = 0;
    for (var i=0; i < res.length;)
    {
      no++;
      var id = res[i++];
      var white_name = res[i++];
      var blue_name  = res[i++];
      var mat_id  = res[i++];
      var state   = res[i++];
      var color   = res[i++];
      var matchtable_id   = res[i++];
      var matchtable_name = res[i++];
      var hansokumake_fighter = res[i++];
      var hansokumake_state   = res[i++];

      var row = table.insertRow(-1);
      var cell0 = row.insertCell(0);
      var cell1 = row.insertCell(1);
      var cell2 = row.insertCell(2);
      var cell3 = row.insertCell(3);
      var cell4 = row.insertCell(4);
      var cell5 = row.insertCell(5);
      var cell6 = row.insertCell(6);

      if (no%2 == 0)
        row.style.backgroundColor = "#eee";

      cell0.innerHTML = no;
      cell0.style.textAlign = "center";
      cell0.style.fontSize  = "14pt";

      cell1.innerHTML = white_name;
      cell2.innerHTML = blue_name;

      cell3.innerHTML = matchtable_name;
      cell3.style.textAlign = "center";

      cell4.innerHTML = mat_id;
      cell4.style.textAlign = "center";
      cell4.style.fontSize  = "16pt";

      if (hansokumake_state == 0)
        cell5.innerHTML = "Hansokumake " + lang.for + " ";
      else if (hansokumake_state == 1)
        cell5.innerHTML = lang.disqualification + " " + lang.for + " ";
      else if (hansokumake_state == 2)
        cell5.innerHTML = lang.no_disqualification + " " + lang.for + " ";

      if (hansokumake_fighter == 0)
        cell5.innerHTML += lang.white;
      else
        cell5.innerHTML += lang.blue;

      cell5.style.fontSize  = "16pt";

      if (hansokumake_state == 0)
      {
        cell6.innerHTML  = "<button class=\"remove\"  style=\"width: 2.5cm; height: 0.9cm;\" onclick=\"return Disqualify("   + hansokumake_fighter + ',' + mat_id+")\">" + "Disqualify" + "</button>";
        cell6.innerHTML += "<button class=\"neutral\" style=\"width: 4.5cm; height: 0.9cm;\" onclick=\"return NoDisqualify(" + hansokumake_fighter + ',' + mat_id+")\">" + "No Disqualification" + "</button>";
      }
      else if (hansokumake_state == 1)
      {
        cell6.innerHTML = "<button class=\"neutral\" style=\"width: 5.5cm; height: 0.9cm;\" onclick=\"return RemoveDisqualify(" + hansokumake_fighter + ',' + +mat_id+")\">" + "Revoke Disqualification" + "</button>";
      }
      else if (hansokumake_state == 2)
      {
        cell6.innerHTML = "<button class=\"neutral\" style=\"width: 6.5cm; height: 0.9cm;\" onclick=\"return RemoveNoDisqualify(" + hansokumake_fighter + ',' + +mat_id+")\">" + "Revoke No Disqualification" + "</button>";
      }

      cell6.style.textAlign = "center";
    }

    if (!showHansokumake)
    {
        $("#div_hansokumake").show().animate({height: 'auto', opacity: 100}, 1000);
        showHansokumake = true;
    }
  });
}


var showHansokumake = false;


Update();
TimerID = window.setInterval(Update, 5000);


document.getElementById("headline").innerHTML = lang.schedule;

document.getElementById("headline-master-schedule").innerHTML = lang.overview;
document.getElementById("headline-participants").innerHTML = lang.participants;

document.getElementById("new_participant").innerHTML = lang.new_participant;
document.getElementById("new_match").innerHTML = lang.new_match;
document.getElementById("new_matchtable").innerHTML = lang.add_matchtable;

//document.getElementById("white").innerHTML = lang.white;
//document.getElementById("blue").innerHTML  = lang.blue;
//document.getElementById("mat").innerHTML   = lang.mat;

for (const el of document.getElementsByClassName("no"))
    el.innerHTML = lang.no;
for (const el of document.getElementsByClassName("white"))
    el.innerHTML = lang.white;
for (const el of document.getElementsByClassName("blue"))
    el.innerHTML = lang.blue;
for (const el of document.getElementsByClassName("class"))
    el.innerHTML = lang.matchtable;
for (const el of document.getElementsByClassName("mat"))
    el.innerHTML = lang.mat;
for (const el of document.getElementsByClassName("options"))
    el.innerHTML = lang.options;
for (const el of document.getElementsByClassName("weight"))
    el.innerHTML = lang.weight;
for (const el of document.getElementsByClassName("num_matches"))
    el.innerHTML = lang.num_matches;
for (const el of document.getElementsByClassName("club"))
    el.innerHTML = lang.club;
for (const el of document.getElementsByClassName("age_group"))
    el.innerHTML = lang.age_group;

document.getElementById("new_participant").innerHTML  = lang.new_participant;
document.getElementById("new_match").innerHTML  = lang.new_match;
document.getElementById("age_groups_participants").innerHTML = lang.num_participants;
document.getElementById("headline_age_groups").innerHTML = lang.age_groups;